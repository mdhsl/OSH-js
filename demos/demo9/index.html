<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title>OSH-js API</title>
    
    <!-- include leaflet -->
    <!-- LEAFLET libs -->
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />	
    <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <!-- FullScreen -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

    <script type="text/javascript" src= "osh-all.min.js"></script>
    <script type="text/javascript" src= "osh-UI-LeafletView.js"></script>
    
<style media="screen" type="text/css">
section {
  margin: auto;
}

.container-vertical {
  width:320px;
  float: left;
}

.container-vertical-2 {
  float:left;
  margin-left: 300px;
  margin-top: 25px;
}

.container-vertical-3 {
  float:left;
}

.video {
  width : 600px;
  height: 500px;
}

.leaflet-container {
     overflow: hidden;
    -ms-touch-action: none;
}

body { 
  margin:0; 
}
#container-map-1 { 
  position:relative; bottom:0; width:500px;height:500px; 
}

.leaflet-overlay-pane path,
.leaflet-marker-icon {
  cursor: pointer;
}

/* for grid */
.grid {
    width: 780px;
    height: 1240px;
}

.grid-cell {
  width: 250px;
  height: 200px;
  outline: 1px solid;
  float: left;
}
</style>
  </head>
    <body>
     <h2>This is a test for the OSH-JS Api</h2>
     <h3>Use of two seperate Video dataSource + dataProvider + OSH View + CSS + Controller. The data are not synchronized. The videos 2 & 3 are fed by the same stream.
     The demo uses 6 streams which feed 4 isolated views.</h3>
     <h3>Use Options: { Buffering:2000, synchronizedTime: false }</h3>
     <section>
        <div class="container-vertical">
          <button type="button" onclick="load()">Load</button>
          <div id="container-map-1"></div>
        </div>
        <section>
          <div class="container-vertical-2">
            <div id="container-multiview"></div>
          </div>
        </section>
      </section>
      
     
      <script type="text/javascript">
      OSH.UI.MultiComponentView = Class.create(OSH.UI.View,{
          initialize: function($super,divId,options) {
              $super(divId);
              //create main div
              this.div = document.createElement('div');
              this.div.setAttribute("class","grid");
              
              document.getElementById(divId).appendChild(this.div);
              this.views = [];
              
              this.viewsDiv = new Hashtable();
          },
          
          addView: function(oshView) {
             var div = document.createElement('div');
             div.setAttribute("class","grid-cell");
             div.appendChild(document.getElementById(oshView.getDivId()));
             this.div.appendChild(div);
             
             this.views.push(oshView);
             this.viewsDiv.put(oshView.getDivId(),div);
          },
          
          selectDataView: function($super,id) {
            for(var i=0;i< this.views.length;i++) {
              var div = this.viewsDiv.get(this.views[i].getDivId());
              if(this.views[i].hasDataView(id)){
                div.style.border = "5px dotted red";
              } else {
                div.style.border = "none";
              }
            }
          },
          
          update: function($super,dataViewId, data) {
            for(var i=0;i < this.views.length; i++) {
              this.views[i].update(dataViewId,data);
            }
          }
      });
      </script>
      <script type="text/javascript">
      
          //MODEL Video
          //2
          var videoDataSource1 = new OSH.DataSource.VideoMjpegDataSource("video1","ws://sensiasoft.net:8181/sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering=urn:android:device:060693280a28e015-sos&observedProperty=http://sensorml.com/ont/swe/property/VideoFrame&temporalFilter=phenomenonTime,2015-02-16T08:01:00Z/2015-02-16T08:09:00Z&replaySpeed=3");
          //4
          var videoDataSource2 = new OSH.DataSource.VideoMjpegDataSource("video2","ws://sensiasoft.net:8181/sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering=urn:android:device:060693280a28e015-sos&observedProperty=http://sensorml.com/ont/swe/property/VideoFrame&temporalFilter=phenomenonTime,2015-02-16T08:03:00Z/2015-02-16T08:09:00Z&replaySpeed=3");
          
          //MODEL GPS
          //2
          var latLonAltDataSource1 = new OSH.DataSource.LatLonAltDataSource("gps1","ws://sensiasoft.net:8181/sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering=urn:android:device:060693280a28e015-sos&observedProperty=http://sensorml.com/ont/swe/property/Location&temporalFilter=phenomenonTime,2015-02-16T08:01:00Z/2015-02-16T08:09:00Z&replaySpeed=3");
          //4
          var latLonAltDataSource2 = new OSH.DataSource.LatLonAltDataSource("gps2","ws://sensiasoft.net:8181/sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering=urn:android:device:060693280a28e015-sos&observedProperty=http://sensorml.com/ont/swe/property/Location&temporalFilter=phenomenonTime,2015-02-16T08:03:00Z/2015-02-16T08:09:00Z&replaySpeed=3");
          
          var dataSourceProvider = new OSH.DataSource.DataSourceProvider({
             bufferingTime:2*1000, // 5 seconds
             synchronizedTime: false, // does not sync the data
             replayFactor:3
          });
          
          dataSourceProvider.addDataSource(videoDataSource1);
          dataSourceProvider.addDataSource(videoDataSource2);
          dataSourceProvider.addDataSource(latLonAltDataSource1);
          dataSourceProvider.addDataSource(latLonAltDataSource2);
          
          //VIEW
          var oshVideoView1 = new OSH.UI.MJpegView("container-video",{
            css:"grid-cell"
          });
          //a view can be fed by a same stream
          var oshVideoView2 = new OSH.UI.MJpegView("container-video-2",{
            css:"grid-cell"
          });
          //a view can be fed by a same stream
          var oshVideoView3 = new OSH.UI.MJpegView("container-video-3",{
            css:"grid-cell"
          });
          var oshVideoView4 = new OSH.UI.MJpegView("container-video-4",{
            css:"grid-cell"
          });
          
          //set dataView for videos
          oshVideoView1.setDataViewId(videoDataSource1.getId());
          oshVideoView2.setDataViewId(videoDataSource2.getId());
          oshVideoView3.setDataViewId(videoDataSource2.getId());
          oshVideoView4.setDataViewId(videoDataSource1.getId());
          
          //set associated dataViews
          oshVideoView1.addAssociatedDataViews([latLonAltDataSource1.getId()]);
          oshVideoView2.addAssociatedDataViews([latLonAltDataSource2.getId()]);
          oshVideoView3.addAssociatedDataViews([latLonAltDataSource2.getId()]);
          oshVideoView4.addAssociatedDataViews([latLonAltDataSource1.getId()]);
          
          //setup multiView to encapsulate the video divs
          var oshMultiView = new OSH.UI.MultiComponentView("container-multiview");
          
          oshMultiView.addView(oshVideoView1);
          oshMultiView.addView(oshVideoView2);
          oshMultiView.addView(oshVideoView3);
          oshMultiView.addView(oshVideoView4);
          
          //creates a map view
          var oshMapView1 = new OSH.UI.LeafletView("container-map-1");
          //add marker to map
          oshMapView1.addDataMarker({
            latLonDataViewId:latLonAltDataSource1.getId(),
            displayPath: true
          });
          
          oshMapView1.addDataMarker({
            latLonDataViewId:latLonAltDataSource2.getId(),
            displayPath: false
          });
          
          //CONTROLLER
          var controller = new OSH.Controller();
          controller.addDataSourceProvider(dataSourceProvider);
          controller.addView(oshMapView1);
          controller.addView(oshMultiView);
          
          // we can also use dataSourceProvider.connectAll() which will connect all streams
          function load() {
              dataSourceProvider.connectAll();
          }
      </script>
        
    </body>
</html>
